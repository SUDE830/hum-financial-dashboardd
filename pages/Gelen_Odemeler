import streamlit as st
import pandas as pd
import plotly.express as px
from pathlib import Path

# =================================================
# SAYFA AYARI
# =================================================
st.set_page_config(
    page_title="HUM | Gelen Ã–demeler",
    page_icon="ğŸ’°",
    layout="wide"
)

# =================================================
# PATH & SABÄ°TLER
# =================================================
BASE_DIR = Path(__file__).resolve().parent.parent
EXCEL_PATH = BASE_DIR / "data" / "HUM_DATA2.xlsx"
LOGO_PATH = BASE_DIR / "hum_logo.png"

# Sayfa Ä°simleri
SHEET_PAYMENTS = "ARPV_BANKAGELEN_KUMULE (2)"
SHEET_DIM = "DIM_PROJELER1"

# KPI Kolon Ä°simleri (DIM_PROJELER1 sayfasÄ±ndaki baÅŸlÄ±klar)
COL_SIPARIS = "SÄ°PARÄ°Å TUTARI"
COL_SATIS   = "SATIÅ TUTARI"
COL_MALIYET = "TOPLAM MALIYET"
COL_TAHSIL  = "TAHSÄ°LAT"

AY_MAP = {
    1: "Ocak", 2: "Åubat", 3: "Mart", 4: "Nisan",
    5: "MayÄ±s", 6: "Haziran", 7: "Temmuz",
    8: "AÄŸustos", 9: "EylÃ¼l", 10: "Ekim",
    11: "KasÄ±m", 12: "AralÄ±k"
}
AY_SIRA = list(AY_MAP.values())

# âœ… DIM_PROJELER1'de gerÃ§ekte kullandÄ±ÄŸÄ±mÄ±z KPI kolon isimleri (doÄŸrusu bu)
# (Ãœstteki tanÄ±mÄ± bozmuyoruz, ama burada doÄŸru kolonlarÄ± â€œstandartâ€ olarak belirliyoruz)
COL_SIPARIS = "PROJE SÄ°PARÄ°Å EURO TUTARLARI"
COL_SATIS   = "PROJE SATIÅ EURO TUTARLARI"
COL_MALIYET = "PROJE MALÄ°YET EURO TUTARLARI"
COL_TAHSIL  = "PROJELERDE GELEN EURO Ã–DEMELERÄ° TUTARI"

# =================================================
# YARDIMCI FONKSÄ°YONLAR (EKSÄ°KLER TAMAMLANDI)
# =================================================
def fmt_money(x):
    try:
        return f"{x:,.0f}".replace(",", "_").replace(".", ",").replace("_", ".")
    except Exception:
        return "0"

def to_number_tr(s):
    """TÃ¼rkÃ§e sayÄ± formatÄ±nÄ± temizler (1.234,56 -> 1234.56)"""
    if s is None:
        return pd.Series(dtype="float")
    if pd.api.types.is_numeric_dtype(s):
        return s.fillna(0.0)

    s = s.astype(str).str.replace(r"[^\d,.\-]", "", regex=True)
    has_dot = s.str.contains(r"\.", regex=True, na=False)
    has_com = s.str.contains(r",", regex=True, na=False)

    s.loc[has_dot & has_com] = (
        s.loc[has_dot & has_com]
        .str.replace(".", "", regex=False)
        .str.replace(",", ".", regex=False)
    )
    s.loc[~has_dot & has_com] = s.loc[~has_dot & has_com].str.replace(",", ".", regex=False)
    return pd.to_numeric(s, errors="coerce").fillna(0.0)

# â— Senin ilk hesapla_kpi fonksiyonun (silmeden bÄ±rakÄ±yoruz, ama kullanmayacaÄŸÄ±z)
def hesapla_kpi_old(df_secili):
    """DIM tablosu Ã¼zerinden KPI Ã¶zetlerini hesaplar (eski)"""
    return {
        "siparis": df_secili[COL_SIPARIS].sum() if COL_SIPARIS in df_secili.columns else 0,
        "satis": df_secili[COL_SATIS].sum() if COL_SATIS in df_secili.columns else 0,
        "maliyet": df_secili[COL_MALIYET].sum() if COL_MALIYET in df_secili.columns else 0,
        "tahsilat": df_secili[COL_TAHSIL].sum() if COL_TAHSIL in df_secili.columns else 0
    }

# =================================================
# DATA LOADING
# =================================================
@st.cache_data(show_spinner=False)
def load_data():
    # Banka Ã–demeleri Verisi
    df = pd.read_excel(EXCEL_PATH, sheet_name=SHEET_PAYMENTS, engine="openpyxl")
    df.columns = df.columns.str.strip()
    df["AY_ADI"] = df["AY"].map(AY_MAP)

    if "PROJE Ã–DEMELERÄ°NÄ°N GELDÄ°ÄÄ° TARÄ°H" in df.columns:
        df["PROJE Ã–DEMELERÄ°NÄ°N GELDÄ°ÄÄ° TARÄ°H"] = pd.to_datetime(
            df["PROJE Ã–DEMELERÄ°NÄ°N GELDÄ°ÄÄ° TARÄ°H"], errors="coerce"
        )

    # KPI Verisi (DIM_PROJELER1)
    df_dim = pd.read_excel(EXCEL_PATH, sheet_name=SHEET_DIM, engine="openpyxl")
    df_dim.columns = df_dim.columns.str.strip()

    for c in [COL_SIPARIS, COL_SATIS, COL_MALIYET, COL_TAHSIL]:
        if c in df_dim.columns:
            df_dim[c] = to_number_tr(df_dim[c])
        else:
            df_dim[c] = 0.0

    # Metin kolon gÃ¼venliÄŸi
    for c in ["ProjeKodu", "ÅÄ°RKET", "CARÄ° Ä°SÄ°M", "ÃœLKE ADI"]:
        if c in df_dim.columns:
            df_dim[c] = df_dim[c].astype(str).str.strip()

    return df, df_dim

df_raw, df_dim_raw = load_data()

# =================================================
# BAÅLIK
# =================================================
c1, c2 = st.columns([1, 7])
with c1:
    if LOGO_PATH.exists():
        st.image(str(LOGO_PATH), width=120)
with c2:
    st.markdown("## HUM | Gelen Ã–demeler")
    st.caption("Banka bazlÄ± aylÄ±k tahsilat analizi ve DIM bazlÄ± proje Ã¶zeti")

st.divider()

# =================================================
# SIDEBAR â€“ FÄ°LTRELER
# =================================================
if st.sidebar.button("ğŸ”„ Verileri GÃ¼ncelle", use_container_width=True):
    st.cache_data.clear()
    st.rerun()

st.sidebar.markdown("### ğŸ” Filtreler")

df = df_raw.copy()
df_kpi_filtered = df_dim_raw.copy()

sirket = st.sidebar.selectbox("Åirket", ["TÃ¼mÃ¼"] + sorted(df["SIRKET"].dropna().unique()))
if sirket != "TÃ¼mÃ¼":
    df = df[df["SIRKET"] == sirket]
    if "ÅÄ°RKET" in df_kpi_filtered.columns:
        df_kpi_filtered = df_kpi_filtered[df_kpi_filtered["ÅÄ°RKET"] == sirket]

cari = st.sidebar.selectbox("Cari", ["TÃ¼mÃ¼"] + sorted(df["CARI_ISIM"].dropna().unique()))
if cari != "TÃ¼mÃ¼":
    df = df[df["CARI_ISIM"] == cari]
    if "CARÄ° Ä°SÄ°M" in df_kpi_filtered.columns:
        df_kpi_filtered = df_kpi_filtered[df_kpi_filtered["CARÄ° Ä°SÄ°M"] == cari]

proje_ara = st.sidebar.text_input("Proje Kodu Ara", placeholder="Ã–rn: C25...")
if proje_ara:
    mask = df["ProjeKodu"].astype(str).str.contains(proje_ara, case=False, na=False)
    df = df[mask]

    if "ProjeKodu" in df_kpi_filtered.columns:
        mask_kpi = df_kpi_filtered["ProjeKodu"].astype(str).str.contains(proje_ara, case=False, na=False)
        df_kpi_filtered = df_kpi_filtered[mask_kpi]

yil = st.sidebar.selectbox("YÄ±l", ["TÃ¼mÃ¼"] + sorted(df["YIL"].dropna().unique()))
if yil != "TÃ¼mÃ¼":
    df = df[df["YIL"] == yil]

ay = st.sidebar.selectbox("Ay", ["TÃ¼mÃ¼"] + AY_SIRA)

# =================================================
# KPI GÃ–STERÄ°MÄ° (DIM_PROJELER1'DEN)  âœ… ANA SAYFA Ä°LE AYNI
# =================================================
def hesapla_kpi(df_dim: pd.DataFrame) -> dict:
    sip = float(df_dim[COL_SIPARIS].sum()) if len(df_dim) else 0.0
    sat = float(df_dim[COL_SATIS].sum()) if len(df_dim) else 0.0
    mal = float(df_dim[COL_MALIYET].sum()) if len(df_dim) else 0.0
    tah = float(df_dim[COL_TAHSIL].sum()) if len(df_dim) else 0.0

    kar = sat - mal
    kar_orani = (kar / sat * 100) if sat else 0.0

    return {
        "proje_sayisi": int(df_dim["ProjeKodu"].nunique()) if "ProjeKodu" in df_dim.columns else 0,
        "siparis": sip,
        "satis": sat,
        "maliyet": mal,
        "tahsilat": tah,
        "kar": kar,
        "kar_orani": kar_orani
    }

kpi = hesapla_kpi(df_kpi_filtered)

k1, k2, k3, k4, k5, k6 = st.columns(6)
k1.metric("Proje SayÄ±sÄ±", kpi["proje_sayisi"])
k2.metric("SipariÅŸ (â‚¬)", fmt_money(kpi["siparis"]))
k3.metric("SatÄ±ÅŸ (â‚¬)", fmt_money(kpi["satis"]))
k4.metric("Maliyet (â‚¬)", fmt_money(kpi["maliyet"]))
k5.metric("Tahsilat (â‚¬)", fmt_money(kpi["tahsilat"]))
k6.metric("KÃ¢r (â‚¬)", fmt_money(kpi["kar"]))
st.caption(f"ğŸ’¡ **KÃ¢r OranÄ±:** {kpi['kar_orani']:.2f}%".replace(".", ","))

st.divider()

# =================================================
# GRAFÄ°K â€“ BAR + LINE
# =================================================
monthly = (
    df.groupby(["AY", "AY_ADI"], as_index=False)
      .agg(
          Tahsilat=("PROJE GELEN EURO Ã–DEMELERÄ°", "sum"),
          Proje_Sayisi=("ProjeKodu", "nunique")
      )
)

monthly = monthly.sort_values("AY")

if monthly.empty:
    st.warning("SeÃ§ilen filtrelerde grafik iÃ§in veri bulunamadÄ±.")
else:
    fig = px.bar(
        monthly, x="AY_ADI", y="Tahsilat",
        text=monthly["Tahsilat"].apply(lambda x: f"{fmt_money(x)} â‚¬"),
        color_discrete_sequence=["#0A66C2"]
    )

    fig.add_scatter(
        x=monthly["AY_ADI"], y=monthly["Proje_Sayisi"],
        mode="lines+markers", name="Ã–deme Gelen Proje SayÄ±sÄ±",
        line=dict(color="#F4B400", width=3), marker=dict(size=8), yaxis="y2"
    )

    fig.update_layout(
        yaxis2=dict(overlaying="y", side="right", title="Proje SayÄ±sÄ±"),
        height=500, plot_bgcolor="white",
        xaxis={'categoryorder': 'array', 'categoryarray': AY_SIRA},
        margin=dict(l=20, r=20, t=30, b=20)
    )
    st.plotly_chart(fig, use_container_width=True)

# =================================================
# ALT KARTLAR (DETAYLAR)
# =================================================
if ay != "TÃ¼mÃ¼" or cari != "TÃ¼mÃ¼" or proje_ara != "":
    if ay != "TÃ¼mÃ¼":
        df_detay = df[df["AY_ADI"] == ay]
        baslik = f"ğŸ“¦ {ay} AyÄ± Tahsilat DetaylarÄ±"
    else:
        df_detay = df.copy()
        baslik = f"ğŸ“¦ FiltrelenmiÅŸ Tahsilat Listesi"

    st.subheader(baslik)
    cols = st.columns(3)

    for i, (idx, row) in enumerate(
        df_detay.sort_values("PROJE GELEN EURO Ã–DEMELERÄ°", ascending=False).iterrows()
    ):
        if "PROJE Ã–DEMELERÄ°NÄ°N GELDÄ°ÄÄ° TARÄ°H" in df_detay.columns:
            dt_str = (
                row["PROJE Ã–DEMELERÄ°NÄ°N GELDÄ°ÄÄ° TARÄ°H"].strftime("%d.%m.%Y")
                if pd.notnull(row["PROJE Ã–DEMELERÄ°NÄ°N GELDÄ°ÄÄ° TARÄ°H"]) else "-"
            )
        else:
            dt_str = "-"

        html_card = f'''
        <div style="background:#ffffff; padding:18px; border-radius:14px; margin-bottom:15px;
                    box-shadow:0 4px 12px rgba(0,0,0,0.08); border-left: 5px solid #0A66C2;">
            <div style="font-weight:700; font-size:16px; color:#333;">{row.get('ProjeKodu', '')}</div>
            <div style="color:#666; font-size:14px; margin-bottom:8px;">{row.get('CARI_ISIM', '')}</div>
            <div style="font-size:12px; color:#888;">
                ğŸ¦ {row.get('BANKA', '')}<br>ğŸ“… {dt_str}
            </div>
            <div style="margin-top:10px; font-size:18px; font-weight:700; color:#0A66C2;">
                â‚¬ {fmt_money(row.get('PROJE GELEN EURO Ã–DEMELERÄ°', 0))}
            </div>
        </div>
        '''
        with cols[i % 3]:
            st.markdown(html_card, unsafe_allow_html=True)

